# CSP (Content Security Policy)

Технология CSP (Content Security Policy, или "политика безопасности контента") — это механизм безопасности, который позволяет веб-сайтам контролировать, какие ресурсы могут быть загружены и выполнены браузером. CSP помогает предотвратить атаки типа XSS (Cross-Site Scripting) и инъекции данных, ограничивая источники, из которых может загружаться контент.

---

## 1. **Что такое CSP?**

CSP — это стандарт безопасности, реализованный в браузерах для предотвращения выполнения вредоносного кода и загрузки нежелательных ресурсов. Политика определяется сервером через HTTP-заголовок `Content-Security-Policy` или мета-тег `<meta>` в HTML.

- **CSP** ограничивает источники, из которых браузер может загружать скрипты, стили, изображения, шрифты и другие ресурсы.
- Политика работает по принципу "whitelist" (белый список) — разрешены только явно указанные источники.
- Если ресурс пытается загрузиться из неразрешённого источника, браузер блокирует его.

---

## 2. **Как работает CSP?**

### a) **Установка политики**

CSP может быть установлена двумя способами:

#### 1. HTTP-заголовок (рекомендуется)

```http
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline';
```

#### 2. Мета-тег в HTML

```html
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline';">
```

### b) **Директивы CSP**

CSP использует директивы для контроля различных типов ресурсов:

#### Основные директивы:

- **`default-src`** — политика по умолчанию для всех типов ресурсов, если не указана специфичная директива.
- **`script-src`** — контролирует источники JavaScript-файлов и inline-скриптов.
- **`style-src`** — контролирует источники CSS-файлов и inline-стилей.
- **`img-src`** — контролирует источники изображений.
- **`font-src`** — контролирует источники шрифтов.
- **`connect-src`** — контролирует источники для XHR, fetch, WebSocket и других сетевых соединений.
- **`media-src`** — контролирует источники аудио и видео.
- **`object-src`** — контролирует источники плагинов (например, `<object>`, `<embed>`).
- **`frame-src`** — контролирует источники для `<iframe>`, `<frame>`.
- **`base-uri`** — ограничивает URL, которые могут использоваться в элементе `<base>`.
- **`form-action`** — ограничивает URL, которые могут использоваться в атрибуте `action` форм.
- **`frame-ancestors`** — определяет, какие страницы могут встроить текущую страницу через `<iframe>`.
- **`report-uri`** — указывает URL, куда отправлять отчёты о нарушениях CSP.

### c) **Ключевые слова**

- **`'self'`** — разрешает загрузку только с того же origin, что и документ.
- **`'unsafe-inline'`** — разрешает inline-скрипты и inline-стили (небезопасно, но иногда необходимо).
- **`'unsafe-eval'`** — разрешает использование `eval()` и подобных функций (крайне небезопасно).
- **`'none'`** — запрещает загрузку ресурсов этого типа.
- **`*`** — разрешает загрузку с любых источников (небезопасно).
- **`https:`** — разрешает загрузку только через HTTPS.

---

## 3. **Примеры политик**

### Базовая политика (строгая)

```http
Content-Security-Policy: 
  default-src 'self'; 
  script-src 'self'; 
  style-src 'self' 'unsafe-inline'; 
  img-src 'self' data: https:; 
  font-src 'self' data:; 
  connect-src 'self';
```

**Что это означает:**
- Все ресурсы по умолчанию только с того же домена (`'self'`)
- Скрипты только с того же домена
- Стили с того же домена, но разрешены inline-стили
- Изображения с того же домена, из data URI и через HTTPS
- Шрифты с того же домена и из data URI
- Сетевые запросы только к тому же домену

### Политика с внешними CDN

```http
Content-Security-Policy: 
  default-src 'self'; 
  script-src 'self' https://cdn.example.com https://ajax.googleapis.com; 
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
  font-src 'self' https://fonts.gstatic.com; 
  img-src 'self' data: https:;
```

**Что это означает:**
- Разрешены скрипты с CDN и Google APIs
- Разрешены стили и шрифты с Google Fonts
- Разрешены изображения с любых HTTPS-источников

### Политика для React/Vue приложений

```http
Content-Security-Policy: 
  default-src 'self'; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'; 
  style-src 'self' 'unsafe-inline'; 
  img-src 'self' data: https:; 
  connect-src 'self' https://api.example.com;
```

**Примечание:** `'unsafe-inline'` и `'unsafe-eval'` часто необходимы для фреймворков, но это снижает безопасность. Для production лучше использовать nonces или hashes.

---

## 4. **CSP и XSS атаки**

CSP — это один из самых эффективных способов защиты от XSS атак:

### Как CSP предотвращает XSS:

1. **Блокировка inline-скриптов** — если злоумышленник попытается внедрить `<script>alert('XSS')</script>`, CSP заблокирует его (если не используется `'unsafe-inline'`).

2. **Контроль источников скриптов** — разрешены только скрипты с доверенных доменов.

3. **Блокировка `eval()`** — предотвращает выполнение динамически сгенерированного кода (если не используется `'unsafe-eval'`).

### Пример атаки, которая будет заблокирована:

```html
<!-- Если пользователь вводит это в форму -->
<script>
  document.cookie = "session=stolen";
</script>

<!-- CSP заблокирует выполнение, если нет 'unsafe-inline' -->
```

---

## 5. **Nonces и Hashes для inline-скриптов**

Вместо использования `'unsafe-inline'` можно использовать более безопасные методы:

### Nonces (Number Used Once)

```http
Content-Security-Policy: script-src 'nonce-2726c7f26c'
```

```html
<script nonce="2726c7f26c">
  // Этот скрипт будет выполнен
</script>

<script>
  // Этот скрипт будет заблокирован
</script>
```

### Hashes (SHA-256)

```http
Content-Security-Policy: script-src 'sha256-abc123...'
```

```html
<script>console.log('Hello');</script>
<!-- Браузер вычисляет SHA-256 хеш и сравнивает с политикой -->
```

---

## 6. **Отчёты о нарушениях**

CSP может отправлять отчёты о нарушениях на указанный URL:

```http
Content-Security-Policy: 
  default-src 'self'; 
  report-uri /api/csp-report;
```

Или использовать более новый формат:

```http
Content-Security-Policy: 
  default-src 'self'; 
  report-to csp-endpoint;
  
Report-To: {"group":"csp-endpoint","max_age":10886400,"endpoints":[{"url":"/api/csp-report"}]}
```

### Формат отчёта

```json
{
  "csp-report": {
    "document-uri": "https://example.com/page",
    "violated-directive": "script-src 'self'",
    "effective-directive": "script-src",
    "original-policy": "default-src 'self'; script-src 'self'",
    "blocked-uri": "https://evil.com/script.js",
    "source-file": "https://example.com/page",
    "line-number": 42
  }
}
```

---

## 7. **Отладка и тестирование CSP**

### Режим "Report-Only"

Для тестирования политики без блокировки ресурсов используйте заголовок `Content-Security-Policy-Report-Only`:

```http
Content-Security-Policy-Report-Only: 
  default-src 'self'; 
  script-src 'self'; 
  report-uri /api/csp-report;
```

В этом режиме нарушения будут только отчитываться, но не блокироваться.

### Проверка в браузере

1. Откройте DevTools (F12)
2. Перейдите на вкладку Console
3. Нарушения CSP будут показаны с предупреждениями
4. Вкладка Network покажет заблокированные ресурсы

---

## 8. **Совместимость с CORS**

CSP и CORS работают на разных уровнях:

- **CORS** — контролирует междоменные HTTP-запросы (XHR, fetch)
- **CSP** — контролирует загрузку всех ресурсов (скрипты, стили, изображения и т.д.)

Они дополняют друг друга:
- CORS определяет, может ли скрипт делать запрос к другому домену
- CSP определяет, может ли браузер загрузить скрипт с другого домена

---

## 9. **Рекомендации по использованию**

### ✅ Лучшие практики:

1. **Начните со строгой политики** — используйте `default-src 'self'` и добавляйте исключения по мере необходимости.

2. **Используйте nonces или hashes** вместо `'unsafe-inline'` для inline-скриптов.

3. **Избегайте `'unsafe-eval'`** — это значительно снижает безопасность.

4. **Используйте Report-Only** для тестирования перед внедрением в production.

5. **Мониторьте отчёты** — анализируйте нарушения для оптимизации политики.

6. **Постепенно ужесточайте политику** — начните с мягких ограничений и ужесточайте со временем.

### ❌ Чего избегать:

- Использования `*` для разрешения всех источников
- Широкого использования `'unsafe-inline'` и `'unsafe-eval'`
- Игнорирования отчётов о нарушениях
- Отключения CSP полностью

---

## 10. **Вывод**

CSP — это мощный инструмент безопасности, который помогает защитить веб-приложения от XSS атак и инъекций вредоносного контента. Хотя настройка CSP может потребовать времени и тестирования, это критически важно для безопасности современных веб-приложений.

**Ключевые моменты:**
- CSP работает на стороне браузера и контролируется сервером
- Используйте строгую политику с минимальными исключениями
- Мониторьте отчёты о нарушениях для оптимизации
- CSP и CORS работают вместе для обеспечения безопасности

Если у вас есть дополнительные вопросы по CSP, уточните их, и я помогу разобраться!

---

*См. также: [CORS](./cors.md)*


